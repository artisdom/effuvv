#!/usr/bin/env node
global.USAGE = `
USAGE: farch-sync

Brings the system state in-line with what is specified in your configuration.
`;

(async () => {
  "use strict";

  try {
    const argv            = require("minimist")(process.argv.slice(2));
    const changes         = require("../lib/singletons/changes.js");
    const commands        = require("require-tree")("../lib/commands");
    const confPathname    = require("../lib/singletons/conf_pathname.js");
    const systemstate     = require("../lib/singletons/systemstate");

    if (argv.help) {
      console.log(global.USAGE);
      process.exit(0);
    }

    if (process.env["USER"] !== "root") {
      console.error("farch-sync must be ran as root");
      process.exit(1);
    }

    const conf = require(confPathname);
    await systemstate.load();

    const arg = Object.assign({}, commands, {
      changes,
      systemstate,
    });

    if (conf.beforePackages) {
      await conf.beforePackages(arg);
    }

    if (conf.packages) {
      await packages(conf.packages);
    }

    if (conf.afterPackages) {
      await conf.afterPackages(arg);
    }

    if (conf.usersAndGroups) {
      await usersAndGroups(conf.usersAndGroups);
    }

    if (conf.services) {
      await services(conf.services);
    }

    await systemstate.save();
  } catch (e) {
    console.error("error occurred:", e.message);
    console.error(e.stack);
    process.exit(1);
  }
})();
